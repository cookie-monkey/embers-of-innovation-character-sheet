<!DOCTYPE html>

<html>

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Embers of Innovation: Character Sheet</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            display: block;
            width: 1200px;
            padding: 50px 0;
            margin: 0 auto;
            font-family: "Montserrat", sans-serif;
            font-size: 16px;
            line-height: normal;
        }

        h1, h2, h3, h4 {
            display: block;
            padding: 0;
            margin: 0;
            font-size: 1em;
            font-weight: 700;
        }

        input {
            display: block;
            flex: 1 1 auto;
            width: 100%;
            padding: 0;
            margin: 0;
            border: none;
            border-bottom: 2px solid black;
            line-height: 1;
            font-family: inherit;
            font-size: 1.2rem;
            font-weight: 400;
        }

        input:hover, input:focus {
            outline: none;
        }

        textarea {
            display: block;
            width: 100%;
            padding: 6px;
            border: 1px solid black;
            font-family: inherit;
            font-size: 1.2rem;
            font-weight: 400;
        }

        textarea:hover, textarea:focus {
            outline: none;
        }

        button {
            display: block;
            cursor: pointer;
        }

        .row {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            justify-content: flex-start;
            align-items: flex-start;
            width: 100%;
            margin: 0;
        }

        .row + .row {
            margin-top: 40px;
        }

        .column {
            display: block;
            flex: 1 1 100%;
            margin: 0;
        }

        .column + .column {
            margin-left: 25px;
        }

        .subsection {
            display: block;
            margin: 0;
        }
        
        .subsection + .subsection {
            margin-top: 20px;
        }

        .title {
            display: block;
            padding: 0;
            margin: 0 0 30px 0;
            font-size: 4rem;
            font-weight: 900;
        }

        .title > sub {
            vertical-align: baseline;
            font-size: 0.5em;
            font-weight: 400;
        }

        .heading {
            display: block;
            padding: 5px 10px;
            margin: 0 0 25px 0;
            background: black;
            color: white;
            font-size: 1.5em;
            font-weight: 900;
            text-transform: uppercase;
        }

        .subheading {
            margin: 25px 0;
            font-weight: 900;
            text-transform: uppercase;
        }

        .aspect {
            display: block;
            margin: 25px 0 0 0;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .aspect > .label {
            display: block;
            margin: 0 0 15px 0;
            text-transform: uppercase;
        }

        .stress-box {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
            position: relative;
            width: 32px;
            height: 32px;
            padding: 0;
            margin: 0;
            border: 2px solid black;
            border-radius: 0;
            font-size: 1.125rem;
            font-weight: bold;
            text-transform: uppercase;
            appearance: none;
        }

        .stress-box > input {
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            border: none;
            background: none;
            appearance: none;
            cursor: pointer;
        }

        .stress-box > input:checked:after {
            content: '';
            display: block;
            flex: 0 0 auto;
            width: 120%;
            height: 3px;
            border-radius: 10px;
            background: black;
            rotate: -45deg;
            opacity: 0.75;
        }

        .stress-track {
            display: flex;
            flex-direction: row;
            align-items: center;
            height: 32px;
            margin: 15px 0 0 0;
            font-weight: 700;
        }

        .stress-track > .label {
            display: block;
            flex: 0 0 auto;
            width: 100px;
            text-transform: uppercase;
        }

        .stress-track > .stress-boxes {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: start;
            flex: 1 1 auto;
            width: 100%;
        }

        .stress-track > .stress-boxes > .stress-box {
            margin: 0 0 0 5px;
        }

        .stress-track > .circle-button {
            margin: 0 0 0 6px;
        }

        .consequence {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin: 15px 0 0 0;
            font-size: 1rem;
            font-weight: bold;
        }

        .consequence > .label {
            display: block;
            flex: 0 0 auto;
            width: 120px;
            margin: 0 0 0 10px;
            text-transform: uppercase;
        }

        .consequence > .text-field {
            display: block;
            flex: 1 1 auto;
            width: 100%;
        }

        .consequence > .circle-button {
            margin: 0 0 0 15px;
        }

        .skill {
            display: flex;
            flex-direction: row;
            justify-content: start;
            align-items: center;
            margin: 10px 0 0 0;
            font-size: 1.25rem;
        }

        .skill > .label {
            text-transform: capitalize;
        }

        .skill > .text-field {
            flex: 0 0 auto;
            width: 40px;
            margin: 0 10px 0 5px;
            font-size: 1em;
            text-align: center;
        }

        .circle-button {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
            width: 22px;
            height: 22px;
            padding: 0;
            margin: 0;
            border: none;
            border-radius: 50%;
            background: black;
            color: white;
            line-height: 1em;
            font-weight: 900;
            font-size: 18px;
            text-align: center;
        }

        @media print {    
            button {
                display: none !important;
            }
        }
    </style>

</head>

<body>

    <div id="app">

        <h1 class="title">Embers of Innovation <sub>Character Sheet</sub></h1>

        <form id="app">

            <div class="row">
                <div class="column">
                    <section>
                        <h2 class="heading">Aspects</h2>
                        <div class="aspect" v-for="aspect in character.aspects">
                            <span class="label">{{aspect.label}}</span>
                            <input type="text" class="text-field" v-model="aspect.description">
                        </div>
                    </section>
                </div>
                <div class="column">
                    <section>
                        <h2 class="heading">Vitals</h2>
                        <div class="subsection">
                            <h3 class="subheading">Stress</h3>
                            <div class="stress-track" v-for="(stressTrack, stressType) in character.stress">
                                <h4 class="label">{{stressType}}</h4>
                                <div class="stress-boxes">
                                    <div class="stress-box" v-for="stressBox in stressTrack">
                                        <span>1</span>
                                        <input type="checkbox" v-model="stressBox.checked">
                                    </div>
                                </div>
                                <button type="button" class="circle-button" @click="removeStressBox(stressType)">−</button>
                                <button type="button" class="circle-button" @click="addStressBox(stressType)">+</button>
                            </div>
                        </div>
                        <div class="subsection">
                            <h3 class="subheading">Consequences</h3>
                            <div v-for="(consequence, index) in character.consequences">
                                <div class="consequence">
                                    <div class="stress-box">{{consequence.stressValue}}</div>
                                    <span class="label">{{consequence.type}}</span>
                                    <input type="text" class="text-field" v-model="consequence.description">
                                    <button type="button" class="circle-button" v-if="!consequence.isFixed" @click="removeConsequence(consequence)">−</button>
                                    <button type="button" class="circle-button" v-if="consequence.isFixed" @click="addConsequence(consequence.type)">+</button>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <div class="row">
                <div class="column">
                    <section>
                        <h2 class="heading">Skills</h2>
                        <div class="skill" v-for="skill in character.skills">
                            <span>+</span>
                            <input type="text" class="text-field" v-model="skill.value">
                            <span class="label">{{skill.label}}</span>
                        </div>
                    </section>
                </div>
                <div class="column">
                    <section>
                        <h2 class="heading">Spheres</h2>
                        <div class="skill" v-for="sphere in character.spheres">
                            <span>+</span>
                            <input type="text" class="text-field" v-model="sphere.value">
                            <span class="label">{{sphere.label}}</span>
                        </div>
                    </section>
                </div>
            </div>

            <div class="row">
                <div class="column">
                    <section>
                        <h2 class="heading">Stunts</h2>
                        <textarea v-model="character.stunts" rows="10"></textarea>
                    </section>
                </div>
            </div>

        </form>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>

    <script>
        function saveCharacter() {
            const form = document.getElementById('character-form');
            const data = Object.fromEntries(new FormData(form).entries());

            localStorage.setItem('data', JSON.stringify(data));
        }
    
        function loadCharacter() {
            const form = document.getElementById('character-form');
            const data = Object.fromEntries(new FormData(form).entries());

            try {
                Object.assign(data, JSON.parse(localStorage.getItem('character-data')));
            } catch {
                alert('Failed to load character data.');
            }

            repeat(() => addStressBox(Stress.PHYSICAL), data['stress-boxes-physical']);
            repeat(() => addStressBox(Stress.MENTAL), data['stress-boxes-mental']);
            repeat(() => addStressBox(Stress.PARADOX), data['stress-boxes-paradox']);

            repeat(() => addConsequence(Consequence.MILD), data['consequences-mild']);
            repeat(() => addConsequence(Consequence.MODERATE), data['consequences-moderate']);
            repeat(() => addConsequence(Consequence.SEVERE), data['consequences-severe']);

            for (const [key, value] of Object.entries(data)) {
                const element = form.elements[key];

                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = value === 'on';
                    } else {
                        element.value = value;
                    }
                }
            }
        }
    </script>

    <script type="module">
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.prod.js';
        
        const CONSEQUENCE_STRESS_VALUE = {
            mild: 2,
            moderate: 4,
            severe: 6,
        };

        const STORAGE_KEY = 'character';

        const Aspect = {
            ARCHMAGE_PERSONA: 'archmage persona',
            FREE: 'aspect',
            HIGH_CONCEPT: 'high concept',
            RELATIONSHIP: 'relationship',
            TROUBLE: 'trouble',
        };

        const Consequence = {
            MILD: 'mild',
            MODERATE: 'moderate',
            SEVERE: 'severe',
        };

        const Skill = {
            ARTIFICERY: 'artificery',
            ATHLETICS: 'athletics',
            COMBAT: 'combat',
            CONTACTS: 'contacts',
            DECEIVE: 'deceive',
            EMPATHY: 'empathy',
            LORE: 'lore',
            PERCEPTION: 'perception',
            PROVOKE: 'provoke',
            RAPPORT: 'rapport',
            SUBTERFUGE: 'subterfuge',
            WILL: 'will',
        };

        const Sphere = {
            PRIME: 'prime',
            MIND: 'mind',
            SPIRIT: 'spirit',
            MATTER: 'matter',
            FORCE: 'force',
            LIFE: 'life',
            CORRESPONDENCE: 'correspondence',
            TIME: 'time',
            ENTROPY: 'entropy',
        };

        const Stress = {
            PHYSICAL: 'physical',
            MENTAL: 'mental',
            PARADOX: 'paradox',
        };

        function createCharacter() {
            return {
                aspects: [
                    createAspect(Aspect.HIGH_CONCEPT),
                    createAspect(Aspect.TROUBLE),
                    createAspect(Aspect.ARCHMAGE_PERSONA),
                    createAspect(Aspect.RELATIONSHIP),
                    createAspect(Aspect.FREE),
                    createAspect(Aspect.FREE),
                ],
                consequences: [
                    createConsequence(Consequence.MILD, true),
                    createConsequence(Consequence.MODERATE, true),
                    createConsequence(Consequence.SEVERE, true),
                ],
                skills: Object.fromEntries(Object.values(Skill).map((name) => [name, createSkill(name)])),
                spheres: Object.fromEntries(Object.values(Sphere).map((name) => [name, createSkill(name)])),
                stress: {
                    [Stress.PHYSICAL]: createStressTrack(3),
                    [Stress.MENTAL]: createStressTrack(3),
                    [Stress.PARADOX]: createStressTrack(3),
                },
                stunts: '',
            };
        }

        function createAspect(label) {
            return {
                label: label,
                description: '',
            };
        }

        function createConsequence(type, isFixed = false) {
            return {
                description: '',
                isFixed: isFixed,
                stressValue: CONSEQUENCE_STRESS_VALUE[type],
                type: type,
            };
        }

        function createSkill(label) {
            return {
                label: label,
                value: '',
            };
        }

        function createStressBox() {
            return {
                checked: false,
            };
        }

        function createStressTrack(length) {
            return Array.from({ length }).map(() => createStressBox());
        }

        function loadCharacter() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);

                if (data) {
                    return JSON.parse(data);
                }
            } catch {
                localStorage.removeItem(STORAGE_KEY);

                alert('Failed to load character data.');
            }
        }

        function saveCharacter(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        createApp({
            data() {
                const character = loadCharacter() ?? createCharacter();

                return {
                    character,
                };
            },
            methods: {
                addStressBox(type) {
                    this.character.stress[type].push(createStressBox(1));
                },
                removeStressBox(type) {
                    this.character.stress[type].pop();
                },
                addConsequence(type) {
                    this.character.consequences.push(createConsequence(type))
                },
                removeConsequence(consequence) {
                    this.character.consequences.splice(this.character.consequences.indexOf(consequence), 1);
                },
            },
            watch: {
                character: {
                    deep: true,
                    handler(data) {
                        saveCharacter(data);
                    },
                },
            },
        }).mount('#app');
    </script>

</body>

</html>
